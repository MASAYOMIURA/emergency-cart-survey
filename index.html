<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>救急カート管理アンケート</title>
  <style>
    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f8ff;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #0066cc;
      text-align: center;
    }
    .question {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      padding: 12px;
      border: none;
      background-color: #f0f0f0;
      border-radius: 5px;
      cursor: pointer;
      text-align: left;
      font-size: 16px;
    }
    button:hover {
      background-color: #e3e3e3;
    }
    button.selected {
      background-color: #0066cc;
      color: white;
    }
    .submit-btn {
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      font-size: 18px;
      text-align: center;
      margin-top: 20px;
    }
    .submit-btn:hover {
      background-color: #45a049;
    }
    .results {
      display: none;
    }
    .chart-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      margin-top: 20px;
    }
    .chart {
      width: 45%;
      margin: 15px 0;
    }
    .pie-container {
      width: 100%;
      height: 350px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .pie-chart {
      width: 250px;
      height: 250px;
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .pie-legend {
      display: flex;
      flex-direction: column;
      margin-left: 30px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .back-btn {
      background-color: #f0f0f0;
    }
    .reset-btn {
      background-color: #ff6666;
      color: white;
    }
    .welcome {
      text-align: center;
      padding: 20px 0;
    }
    .welcome-btn {
      display: block;
      width: 80%;
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      font-size: 18px;
      background-color: #0066cc;
      color: white;
      text-align: center;
    }
    .checkbox-option {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .checkbox-option:hover {
      background-color: #e3e3e3;
    }
    .checkbox-option input {
      margin-right: 10px;
      width: 18px;
      height: 18px;
    }
    .checkbox-option.selected {
      background-color: #e6f0ff;
      border: 1px solid #0066cc;
    }
    .horizontal-bar-chart {
      width: 100%;
      margin-top: 20px;
    }
    .h-bar-container {
      margin-top: 15px;
    }
    .h-bar-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .h-bar-label {
      width: 30%;
      padding-right: 15px;
      text-align: right;
      font-size: 14px;
    }
    .h-bar-outer {
      width: 60%;
      background-color: #f0f0f0;
      height: 25px;
      border-radius: 5px;
      position: relative;
    }
    .h-bar {
      height: 100%;
      background-color: #0066cc;
      border-radius: 5px;
      transition: width 0.5s;
    }
    .h-bar-value {
      position: absolute;
      right: -70px;
      top: 2px;
      width: 65px;
      text-align: left;
      white-space: nowrap;
    }
    .action-buttons {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .action-buttons button {
      flex: 1;
      min-width: 180px;
    }
    .total-selections {
      margin-top: 15px;
      text-align: right;
      color: #0066cc;
    }
    .total-text {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .total-info {
      font-size: 13px;
      font-style: italic;
    }
    .total-responses {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin: 20px 0;
      padding: 10px;
      background-color: #f0f8ff;
      border-radius: 5px;
    }
    .save-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .save-option-btn {
      flex: 1;
      min-width: 200px;
      padding: 15px;
      text-align: center;
      border-radius: 5px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .save-option-btn svg {
      margin-right: 10px;
    }
    .email-btn {
      background-color: #4CAF50;
      color: white;
    }
    .csv-btn {
      background-color: #ffc107;
      color: #333;
    }
    .capture-btn {
      background-color: #0066cc;
      color: white;
    }
    #capture-area {
      position: relative;
    }
    .capture-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      display: none;
    }
    .capture-preview {
      max-width: 80%;
      max-height: 80%;
      border: 10px solid white;
      border-radius: 5px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    .capture-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    .capture-buttons button {
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    .save-capture-btn {
      background-color: #4CAF50;
      color: white;
    }
    .cancel-capture-btn {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- トップ画面 -->
    <div id="welcome" class="welcome">
      <h1>救急カート管理アンケート</h1>
      <button class="welcome-btn" onclick="showSurvey()">アンケートに回答する</button>
      <button class="welcome-btn" onclick="showResults()">回答をみる</button>
    </div>
    
    <!-- アンケート画面 -->
    <div id="survey" style="display: none;">
      <h1>救急カート管理アンケート</h1>
      
      <div class="question">
        <h2>1. どのくらいの頻度で救急カートの定数管理をしていますか？</h2>
        <div class="options" id="q1-options">
          <button onclick="selectOption('q1', 0)">各勤務帯</button>
          <button onclick="selectOption('q1', 1)">1日に1回</button>
          <button onclick="selectOption('q1', 2)">週に1回</button>
          <button onclick="selectOption('q1', 3)">使用の都度</button>
          <button onclick="selectOption('q1', 4)">その他</button>
        </div>
      </div>
      
      <div class="question">
        <h2>2. 救急カートの定数管理に負担を感じますか？</h2>
        <div class="options" id="q2-options">
          <button onclick="selectOption('q2', 0)">感じる</button>
          <button onclick="selectOption('q2', 1)">まあまあ感じる</button>
          <button onclick="selectOption('q2', 2)">あまり感じない</button>
          <button onclick="selectOption('q2', 3)">感じない</button>
        </div>
      </div>
      
      <div class="question">
        <h2>3. 救急カート管理で困っていることは何ですか？（複数選択可）</h2>
        <div class="options" id="q3-options">
          <div class="checkbox-option">
            <input type="checkbox" id="q3-0" name="q3" value="0">
            <label for="q3-0">定数確認の時間がかかる</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="q3-1" name="q3" value="1">
            <label for="q3-1">使用実績を追えないことがある</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="q3-2" name="q3" value="2">
            <label for="q3-2">使用後の補充忘れがある</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="q3-3" name="q3" value="3">
            <label for="q3-3">期限切れの管理が難しい</label>
          </div>
        </div>
      </div>
      
      <button class="submit-btn" onclick="submitSurvey()">送信する</button>
      <button class="back-btn" onclick="showWelcome()">トップに戻る</button>
    </div>
    
    <!-- 結果画面 -->
    <div id="results" class="results">
      <div id="capture-area">
        <h1>アンケート結果</h1>
        
        <div class="total-responses" id="total-responses">
          総回答者数: 0人
        </div>
        
        <div class="chart-container">
          <!-- 円グラフ1 -->
          <div class="chart">
            <h2>定数管理の頻度</h2>
            <div class="pie-container">
              <div class="pie-chart" id="frequency-pie-chart"></div>
              <div class="pie-legend" id="frequency-legend">
                <!-- 動的に生成 -->
              </div>
            </div>
          </div>
          
          <!-- 円グラフ2 -->
          <div class="chart">
            <h2>定数管理の負担感</h2>
            <div class="pie-container">
              <div class="pie-chart" id="burden-pie-chart"></div>
              <div class="pie-legend" id="burden-legend">
                <!-- 動的に生成 -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- 横棒グラフ -->
        <div class="horizontal-bar-chart">
          <h2>救急カート管理の課題</h2>
          <div class="h-bar-container" id="issues-chart">
            <!-- 動的に生成 -->
          </div>
        </div>
      </div>
      
      <!-- 保存オプション -->
      <h2>結果を保存</h2>
      <div class="save-options">
        <button class="save-option-btn email-btn" onclick="sendEmail()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C19.5304 19 20.0391 18.7893 20.4142 18.4142C20.7893 18.0391 21 17.5304 21 17V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V17C3 17.5304 3.21071 18.0391 3.58579 18.4142C3.96086 18.7893 4.46957 19 5 19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          メールで送信
        </button>
        <button class="save-option-btn csv-btn" onclick="downloadCSV()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 3V7C14 7.26522 14.1054 7.51957 14.2929 7.70711C14.4804 7.89464 14.7348 8 15 8H19M14 3H7C6.46957 3 5.96086 3.21071 5.58579 3.58579C5.21071 3.96086 5 4.46957 5 5V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V8M14 3L19 8M9 17H15M9 13H15M9 9H10" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          CSVで保存
        </button>
        <button class="save-option-btn capture-btn" onclick="captureScreen()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6C13.6569 6 15 7.34315 15 9Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 17L17.2 13.8667C17.0423 13.6687 16.8395 13.5081 16.6073 13.3966C16.375 13.2851 16.1185 13.2247 15.8583 13.2197C15.5981 13.2148 15.3393 13.2654 15.1023 13.368C14.8654 13.4705 14.6558 13.6234 14.49 13.8147L11.49 17.5667C11.3262 17.768 11.1181 17.9294 10.8817 18.0379C10.6452 18.1464 10.3864 18.1993 10.1248 18.192C9.86312 18.1847 9.6077 18.1174 9.37817 17.9956C9.14864 17.8738 8.95123 17.7004 8.8 17.49L3 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 21H16C17.5913 21 19.1174 20.3679 20.2426 19.2426C21.3679 18.1174 22 16.5913 22 15V9C22 7.4087 21.3679 5.88258 20.2426 4.75736C19.1174 3.63214 17.5913 3 16 3H8C6.4087 3 4.88258 3.63214 3.75736 4.75736C2.63214 5.88258 2 7.4087 2 9V15C2 16.5913 2.63214 18.1174 3.75736 19.2426C4.88258 20.3679 6.4087 21 8 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          画面キャプチャ
        </button>
      </div>
      
      <!-- 操作ボタン -->
      <div class="action-buttons">
        <button class="submit-btn" onclick="sendEmail()">結果を保存</button>
        <button class="reset-btn" onclick="resetResults()">すべての回答をリセット</button>
        <button class="back-btn" onclick="showWelcome()">トップに戻る</button>
      </div>
    </div>
  </div>
  
  <!-- キャプチャ用オーバーレイ -->
  <div class="capture-overlay" id="capture-overlay">
    <img class="capture-preview" id="capture-preview" />
    <div class="capture-buttons">
      <button class="save-capture-btn" onclick="saveCapture()">保存する</button>
      <button class="cancel-capture-btn" onclick="cancelCapture()">キャンセル</button>
    </div>
  </div>

  <!-- html2canvas ライブラリの読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // 保存用データ
    let surveyData = {
      q1: [0, 0, 0, 0, 0], // 各勤務帯, 1日に1回, 週に1回, 使用の都度, その他
      q2: [0, 0, 0, 0],    // 感じる, まあまあ感じる, あまり感じない, 感じない
      q3: [0, 0, 0, 0]     // 定数確認の時間, 使用実績, 補充忘れ, 期限切れ
    };
    
    // 画面キャプチャ用変数
    let captureImage = null;
    
    // ローカルストレージから読み込み
    function loadData() {
      const savedData = localStorage.getItem('emergencyCartSurvey');
      if (savedData) {
        surveyData = JSON.parse(savedData);
        updateAllCharts();
      }
    }
    
    // データを保存
    function saveData() {
      localStorage.setItem('emergencyCartSurvey', JSON.stringify(surveyData));
    }
    
    // 選択された回答を記録する
    const answers = {
      q1: null,
      q2: null,
      q3: []
    };
    
    // 表示画面の切り替え
    function showWelcome() {
      document.getElementById('welcome').style.display = 'block';
      document.getElementById('survey').style.display = 'none';
      document.getElementById('results').style.display = 'none';
    }
    
    function showSurvey() {
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('survey').style.display = 'block';
      document.getElementById('results').style.display = 'none';
      
      // 選択をリセット
      resetAnswers();
    }
    
    function showResults() {
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('survey').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      
      // チャートを更新
      updateAllCharts();
    }
    
    // 選択肢リセット
    function resetAnswers() {
      // 通常の選択肢をリセット
      const buttons = document.querySelectorAll('.options button');
      buttons.forEach(btn => btn.classList.remove('selected'));
      
      // チェックボックスをリセット
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = false;
        cb.parentElement.classList.remove('selected');
      });
      
      // 回答をリセット
      answers.q1 = null;
      answers.q2 = null;
      answers.q3 = [];
    }
    
    // 単一選択の回答選択
    function selectOption(question, index) {
      // 以前の選択を解除
      const buttons = document.querySelectorAll(`#${question}-options button`);
      buttons.forEach(btn => btn.classList.remove('selected'));
      
      // 新しい選択を記録
      buttons[index].classList.add('selected');
      answers[question] = index;
    }
    
    // チェックボックスの選択を処理
    document.addEventListener('DOMContentLoaded', function() {
      const checkboxOptions = document.querySelectorAll('.checkbox-option');
      checkboxOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          const checkbox = this.querySelector('input[type="checkbox"]');
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
          }
          
          if (checkbox.checked) {
            this.classList.add('selected');
            if (!answers.q3.includes(parseInt(checkbox.value))) {
              answers.q3.push(parseInt(checkbox.value));
            }
          } else {
            this.classList.remove('selected');
            answers.q3 = answers.q3.filter(val => val !== parseInt(checkbox.value));
          }
        });
      });
    });
    
    // アンケートを送信する関数
    function submitSurvey() {
      // 問1と問2の回答を確認
      if (answers.q1 === null || answers.q2 === null) {
        alert('問1と問2に回答してください');
        return;
      }
      
      // 問3は少なくとも1つ選択されているか確認
      if (answers.q3.length === 0) {
        alert('問3で少なくとも1つ選択してください');
        return;
      }
      
      // 回答を集計データに追加
      surveyData.q1[answers.q1]++;
      surveyData.q2[answers.q2]++;
      answers.q3.forEach(index => {
        surveyData.q3[index]++;
      });
      
      // データを保存
      saveData();
      
      // 結果画面を表示
      showResults();
      
      // 回答完了メッセージ
      alert('アンケートの回答ありがとうございます！');
    }
    
    // 全てのチャートを更新
    function updateAllCharts() {
      updateTotalResponses();
      updatePieChart('frequency', surveyData.q1, [
        { label: '各勤務帯', color: '#FF6384' },
        { label: '1日に1回', color: '#36A2EB' },
        { label: '週に1回', color: '#FFCE56' },
        { label: '使用の都度', color: '#4BC0C0' },
        { label: 'その他', color: '#9966FF' }
      ]);
      
      updatePieChart('burden', surveyData.q2, [
        { label: '感じる', color: '#FF6384' },
        { label: 'まあまあ感じる', color: '#FFCE56' },
        { label: 'あまり感じない', color: '#4BC0C0' },
        { label: '感じない', color: '#36A2EB' }
      ]);
      
      updateHorizontalBarChart('issues', surveyData.q3, [
        { label: '定数確認の時間がかかる', color: '#0066cc' },
        { label: '使用実績を追えないことがある', color: '#4BC0C0' },
        { label: '使用後の補充忘れがある', color: '#FFCE56' },
        { label: '期限切れの管理が難しい', color: '#FF6384' }
      ]);
    }
    
    // 総回答者数を更新
    function updateTotalResponses() {
      // 回答者数 = 問1の合計（最も基本的な質問なので）
      const totalResponses = surveyData.q1.reduce((a, b) => a + b, 0);
      document.getElementById('total-responses').textContent = `総回答者数: ${totalResponses}人`;
    }
    
    // 円グラフを更新する関数
    function updatePieChart(id, data, options) {
      // 合計を計算
      const total = data.reduce((a, b) => a + b, 0);
      
      // レジェンドを更新
      const legendElement = document.getElementById(`${id}-legend`);
      legendElement.innerHTML = '';
      
      // データがある場合のみ処理
      if (total > 0) {
        // 円グラフのセグメントを生成するための配列
        let segments = [];
        let currentPercent = 0;
        
        data.forEach((value, index) => {
          if (value === 0) return; // 値が0ならスキップ
          
          const percent = Math.round((value / total) * 100);
          const nextPercent = currentPercent + percent;
          
          // セグメント情報を保存
          segments.push({
            color: options[index].color,
            start: currentPercent,
            end: nextPercent
          });
          
          // レジェンド項目を作成
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `
            <div class="legend-color" style="background-color: ${options[index].color};"></div>
            <div class="legend-text">${options[index].label}: ${value}人 (${percent}%)</div>
          `;
          legendElement.appendChild(legendItem);
          
          currentPercent = nextPercent;
        });
        
        // conic-gradientを生成
        const pieChart = document.getElementById(`${id}-pie-chart`);
        if (segments.length > 0) {
          let gradient = 'conic-gradient(';
          
          segments.forEach((segment, i) => {
            gradient += `${segment.color} ${segment.start}% ${segment.end}%`;
            if (i < segments.length - 1) {
              gradient += ', ';
            }
          });
          
          gradient += ')';
          pieChart.style.background = gradient;
        } else {
          pieChart.style.background = '#e0e0e0';
        }
      } else {
        // データがない場合は灰色の円を表示
        document.getElementById(`${id}-pie-chart`).style.background = '#e0e0e0';
        
        // 「データなし」表示
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = '<div class="legend-text">データなし</div>';
        legendElement.appendChild(legendItem);
      }
    }
    
    // 横棒グラフを更新する関数
    function updateHorizontalBarChart(id, data, options) {
      const chartElement = document.getElementById(`${id}-chart`);
      chartElement.innerHTML = '';
      
      // データを値の大きい順にソート
      const sortedIndices = [...data.keys()].sort((a, b) => data[b] - data[a]);
      
      // 最大値を取得
      const maxValue = Math.max(...data);
      
      // 総回答者数を取得 (問1の合計)
      const totalRespondents = surveyData.q1.reduce((a, b) => a + b, 0);
      
      // 各項目の棒グラフを作成
      sortedIndices.forEach(index => {
        const value = data[index];
        const percent = maxValue > 0 ? (value / maxValue) * 100 : 0;
        const percentOfRespondents = totalRespondents > 0 ? Math.round((value / totalRespondents) * 100) : 0;
        
        const barRow = document.createElement('div');
        barRow.className = 'h-bar-row';
        barRow.innerHTML = `
          <div class="h-bar-label">${options[index].label}</div>
          <div class="h-bar-outer">
            <div class="h-bar" style="width: ${percent}%; background-color: ${options[index].color};"></div>
          </div>
          <div class="h-bar-value">${value}人</div>
        `;
        
        chartElement.appendChild(barRow);
      });
    }
    
    // メールで送信
    function sendEmail() {
      const totalResponses = surveyData.q1.reduce((a, b) => a + b, 0);
      
      if (totalResponses === 0) {
        alert('回答データがありません。');
        return;
      }
      
      try {
        // メールの本文を作成
        let bodyContent = `救急カート管理アンケート結果\n\n`;
        bodyContent += `総回答者数: ${totalResponses}人\n\n`;
        
        // 問1の結果
        bodyContent += `■ 定数管理の頻度\n`;
        const q1Labels = ['各勤務帯', '1日に1回', '週に1回', '使用の都度', 'その他'];
        q1Labels.forEach((label, index) => {
          bodyContent += `${label}: ${surveyData.q1[index]}人\n`;
        });
        
        bodyContent += `\n■ 定数管理の負担感\n`;
        const q2Labels = ['感じる', 'まあまあ感じる', 'あまり感じない', '感じない'];
        q2Labels.forEach((label, index) => {
          bodyContent += `${label}: ${surveyData.q2[index]}人\n`;
        });
        
        bodyContent += `\n■ 救急カート管理の課題\n`;
        const q3Labels = ['定数確認の時間がかかる', '使用実績を追えないことがある', '使用後の補充忘れがある', '期限切れの管理が難しい'];
        q3Labels.forEach((label, index) => {
          const percentOfRespondents = totalResponses > 0 ? Math.round((surveyData.q3[index] / totalResponses) * 100) : 0;
          bodyContent += `${label}: ${surveyData.q3[index]}人\n`;
        });
        
        // URIエンコーディングを正しく適用
        const encodedSubject = encodeURIComponent('救急カート管理アンケート結果');
        const encodedBody = encodeURIComponent(bodyContent);
        
        // mailto:リンクの作成と実行
        const mailtoLink = `mailto:masayo.miura@sato-global.com?subject=${encodedSubject}&body=${encodedBody}`;
        
        console.log("メール送信リンク生成:", mailtoLink);
        
        // メーラーを開く - ダイアログを表示して確認する
        if (confirm('メーラーを開いて結果を送信しますか？')) {
          // 直接リンクを開く
          window.location.href = mailtoLink;
          
          // 数秒後に確認
          setTimeout(() => {
            const userConfirm = confirm('メーラーは正常に開きましたか？\n\n開かない場合は、ブラウザの設定でメールクライアントとの連携を許可してください。');
            if (!userConfirm) {
              alert('代替方法: メール内容をコピーして、手動でメールを送信することもできます。');
              
              // クリップボードにコピー
              const textArea = document.createElement('textarea');
              textArea.value = bodyContent;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              
              alert('メール内容をクリップボードにコピーしました。メーラーで新規メールを作成し、貼り付けてください。');
            }
          }, 2000);
        }
      } catch (error) {
        console.error("メール送信エラー:", error);
        alert('メール送信に問題が発生しました。エラー: ' + error.message);
      }
    }
    
    // CSVとしてダウンロードする関数
    function downloadCSV() {
      const totalResponses = surveyData.q1.reduce((a, b) => a + b, 0);
      
      if (totalResponses === 0) {
        alert('回答データがありません。');
        return;
      }
      
      try {
        // CSVヘッダー
        let csvContent = "データ種類,項目,回答数\n";
        
        // 問1のデータ
        const q1Labels = ['各勤務帯', '1日に1回', '週に1回', '使用の都度', 'その他'];
        q1Labels.forEach((label, index) => {
          const value = surveyData.q1[index];
          csvContent += `定数管理の頻度,${label},${value}\n`;
        });
        
        // 問2のデータ
        const q2Labels = ['感じる', 'まあまあ感じる', 'あまり感じない', '感じない'];
        q2Labels.forEach((label, index) => {
          const value = surveyData.q2[index];
          csvContent += `定数管理の負担感,${label},${value}\n`;
        });
        
        // 問3のデータ
        const q3Labels = ['定数確認の時間がかかる', '使用実績を追えないことがある', '使用後の補充忘れがある', '期限切れの管理が難しい'];
        q3Labels.forEach((label, index) => {
          const value = surveyData.q3[index];
          csvContent += `救急カート管理の課題,${label},${value}\n`;
        });
        
        // 総計データ
        csvContent += `\n総回答者数,${totalResponses}\n`;
        
        // BOMを追加してShift-JISでの文字化けを防ぐ
        const BOM = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([BOM, csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        // ダウンロードリンクを作成して自動クリック
        const link = document.createElement('a');
        const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD形式
        link.download = `救急カート管理アンケート結果_${date}.csv`;
        link.href = url;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        // クリーンアップ
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 100);
        
        return true;
      } catch (error) {
        console.error("CSVダウンロードエラー:", error);
        alert('CSVダウンロードに問題が発生しました。エラー: ' + error.message);
        return false;
      }
    }
    
    // 画面キャプチャ機能
    function captureScreen() {
      const captureArea = document.getElementById('capture-area');
      const overlay = document.getElementById('capture-overlay');
      const preview = document.getElementById('capture-preview');
      
      // キャプチャ中の表示
      const processingDiv = document.createElement('div');
      processingDiv.style.position = 'fixed';
      processingDiv.style.top = '50%';
      processingDiv.style.left = '50%';
      processingDiv.style.transform = 'translate(-50%, -50%)';
      processingDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      processingDiv.style.color = 'white';
      processingDiv.style.padding = '20px';
      processingDiv.style.borderRadius = '10px';
      processingDiv.style.zIndex = '9999';
      processingDiv.textContent = '画面キャプチャ処理中...';
      document.body.appendChild(processingDiv);
      
      // 少し遅延させてUIの更新を反映
      setTimeout(() => {
        // html2canvasを使ってキャプチャ
        html2canvas(captureArea, {
          backgroundColor: 'white',
          scale: 2, // 高解像度対応
          logging: false,
          useCORS: true
        }).then(canvas => {
          // キャプチャ完了
          document.body.removeChild(processingDiv);
          
          // キャプチャ画像をデータURLとして保存
          captureImage = canvas.toDataURL('image/png');
          
          // プレビュー表示
          preview.src = captureImage;
          overlay.style.display = 'flex';
        }).catch(error => {
          document.body.removeChild(processingDiv);
          console.error('キャプチャエラー:', error);
          alert('画面キャプチャに失敗しました: ' + error.message);
        });
      }, 100);
    }
    
    // キャプチャをキャンセル
    function cancelCapture() {
      document.getElementById('capture-overlay').style.display = 'none';
    }
    
    // キャプチャを保存
    function saveCapture() {
      if (!captureImage) {
        alert('キャプチャ画像がありません。');
        return;
      }
      
      try {
        // ダウンロードリンクを作成
        const link = document.createElement('a');
        const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD形式
        link.download = `救急カート管理アンケート_${date}.png`;
        link.href = captureImage;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        // クリーンアップ
        setTimeout(() => {
          document.body.removeChild(link);
          document.getElementById('capture-overlay').style.display = 'none';
        }, 100);
      } catch (error) {
        console.error('画像保存エラー:', error);
        alert('画像の保存に失敗しました: ' + error.message);
      }
    }
    
    // 全ての結果をリセットする関数
    function resetResults() {
      if (confirm('すべての集計データをリセットしますか？この操作は元に戻せません。')) {
        // データをリセット
        surveyData = {
          q1: [0, 0, 0, 0, 0],
          q2: [0, 0, 0, 0],
          q3: [0, 0, 0, 0]
        };
        
        // ローカルストレージをクリア
        localStorage.removeItem('emergencyCartSurvey');
        
        // グラフを更新
        updateAllCharts();
        
        alert('すべてのデータをリセットしました。');
      }
    }
    
    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      // トップ画面を表示
      showWelcome();
      
      // 保存されたデータを読み込む
      loadData();
    });
  </script>
</body>
</html>
